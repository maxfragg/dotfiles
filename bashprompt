#!/bin/bash
##################
##	BASH PROMPT	##
##################

function timer_start {
  timer=${timer:-$SECONDS}
}

function timer_stop {
  timer_show=$(($SECONDS - $timer))
  unset timer
}


## Fancy PWD display function
## The home directory (HOME) is replaced with a ~
## The last pwdmaxlen characters of the PWD are displayed
## Leading partial directory names are striped off
## /home/me/stuff          -> ~/stuff               if USER=me
## /usr/share/big_dir_name -> ../share/big_dir_name if pwdmaxlen=20

#run each time
function bash_prompt_command() {
    # set an error string for the prompt, if applicable
    if [ $? -eq 0 ]; then
        local ERRPROMPT=""
    else
        local ERRPROMPT='->$[$?]\n\a'
    fi

    # echo a bell-character if execution took more than 3 seconds
    timer_stop
    if [ $timer_show -gt 3 ]; then
        #echo -e
        local TIMES='[$timer_show s]\n\a'
    else
        local TIMES=""
    fi

    # How many characters of the $PWD should be kept
    local pwdmaxlen=20
    local newline=""
    [[ `tput cols` -lt 110 ]] && pwdmaxlen=10
    [[ `tput cols` -lt 85 ]] && newline="\n"

    # Indicate that there has been dir truncation
    local trunc_symbol=".."
    local dir=${PWD##*/}
    pwdmaxlen=$(( ( pwdmaxlen < ${#dir} ) ? ${#dir} : pwdmaxlen ))
    NEW_PWD=${PWD/#$HOME/\~}
    local pwdoffset=$(( ${#NEW_PWD} - pwdmaxlen ))
    if [ ${pwdoffset} -gt "0" ]
    then
        NEW_PWD=${NEW_PWD:$pwdoffset:$pwdmaxlen}
        NEW_PWD=${trunc_symbol}/${NEW_PWD#*/}
    fi
    
    PS1="${TITLEBAR}\
${R}${TIMES}${ERRPROMPT}\
${HC}[\
${UC}\u\
${HC}${LOC}${HOST_S}\
${UC}${NEW_PWD}\
${HC}]\
$newline${UC}\
\$ ${NONE}"
}

#run once per sheell
function bash_prompt() {

    case $TERM in
     xterm*|rxvt*)
         TITLEBAR='\[\033]0;\u:${NEW_PWD}\007\]'
          ;;
     *)
         TITLEBAR=""
          ;;
    esac

    source ~/.bash_config

    # user's color
    UC="$config_prompt_user_color"
    HC="$config_prompt_host_color"
    HOST_S="$config_prompt_hostname"


	# LOCation
	LOC="•"
	[ -n "$SSH_CONNECTION" ] && LOC="✈"

	# root's color
    [ $UID -eq "0" ] && UC=$EMR && HC=$EMW

}

trap 'timer_start' DEBUG
PROMPT_COMMAND=bash_prompt_command
bash_prompt
unset bash_prompt
